@page "/admin/grocery-items/edit/{id:int}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@using GroceryApp.Models
@using GroceryApp.Services
@using System.ComponentModel.DataAnnotations
@inject IGroceryItemService GroceryItemService
@inject NavigationManager Navigation

<PageTitle>Edit Grocery Item</PageTitle>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-warning">
          <h2>Edit Grocery Item</h2>
        </div>
        <div class="card-body">
          @if (isLoading)
          {
            <p><em>Loading...</em></p>
          }
          else if (notFound)
          {
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle"></i> Item not found.
            </div>
            <button class="btn btn-secondary" @onclick="GoBack">
              <i class="bi bi-arrow-left"></i> Back to List
            </button>
          }
          else
          {
            @* ⚠️ ADD FormName here *@
            <EditForm Model="@input" OnValidSubmit="HandleSubmit">
              <DataAnnotationsValidator />
                            
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Name</label>
                  <InputText @bind-Value="input.Name" class="form-control" />
                  <ValidationMessage For="@(() => input.Name)" />
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Category</label>
                  <InputSelect @bind-Value="input.Category" class="form-select">
                    <option value="">-- Select Category --</option>
                    <option value="Fruits">Fruits</option>
                    <option value="Vegetables">Vegetables</option>
                    <option value="Dairy">Dairy</option>
                    <option value="Meat">Meat</option>
                    <option value="Bakery">Bakery</option>
                    <option value="Grains">Grains</option>
                    <option value="Beverages">Beverages</option>
                    <option value="Snacks">Snacks</option>

                  </InputSelect>
                  <ValidationMessage For="@(() => input.Category)" />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Price</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <InputNumber @bind-Value="input.Price" class="form-control" step="0.01" />
                  </div>
                  <ValidationMessage For="@(() => input.Price)" />
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Stock</label>
                  <InputNumber @bind-Value="input.Stock" class="form-control" />
                  <ValidationMessage For="@(() => input.Stock)" />
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <InputTextArea @bind-Value="input.Description" class="form-control" rows="3" />
                <ValidationMessage For="@(() => input.Description)" />
              </div>

              <div class="mb-3">
                <label class="form-label">Image URL</label>
                <InputText @bind-Value="input.ImageUrl" class="form-control" />
                <ValidationMessage For="@(() => input.ImageUrl)" />
              </div>

              <div class="mb-3 form-check">
                <InputCheckbox @bind-Value="input.IsAvailable" class="form-check-input" id="isAvailable" />
                <label class="form-check-label" for="isAvailable">
                  Available for sale
                </label>
              </div>

              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" @onclick="GoBack">
                  <i class="bi bi-arrow-left"></i> Back to List
                </button>
                <button type="submit" class="btn btn-warning">
                  <i class="bi bi-save"></i> Save Changes
                </button>
              </div>
            </EditForm>
          }
        </div>
      </div>
    </div>
  </div>
</div>

@code {
  [Parameter]
  public int Id { get; set; }

  private GroceryItemInput input = new();
  private bool isLoading = true;
  private bool notFound = false;

  protected override async Task OnInitializedAsync()
  {
    var item = await GroceryItemService.GetByIdAsync(Id);
        
    if (item == null)
    {
      notFound = true;
    }
    else
    {
      input = new GroceryItemInput
      {
        Name = item.Name,
        Price = item.Price,
        Description = item.Description,
        Category = item.Category,
        ImageUrl = item.ImageUrl,
        Stock = item.Stock,
        IsAvailable = item.IsAvailable
      };
    }
        
    isLoading = false;
    StateHasChanged();
  }

  private async Task HandleSubmit()
  {
    var item = await GroceryItemService.GetByIdAsync(Id);
      
    if (item == null)
    {
      notFound = true;
      return;
    }

    item.Name = input.Name;
    item.Price = input.Price;
    item.Description = input.Description;
    item.Category = input.Category ?? "";
    item.ImageUrl = input.ImageUrl;
    item.Stock = input.Stock;
    item.IsAvailable = input.IsAvailable;
    item.UpdatedAt = DateTime.UtcNow;

    try
    {
      await GroceryItemService.UpdateAsync(item);
      Navigation.NavigateTo("/admin/grocery-items");
    }
    catch (Microsoft.AspNetCore.Components.NavigationException)
    {
      // Ignore: Blazor normal navigation
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Error updating: {ex.Message}");
    }
  }


  private void GoBack()
  {
    Navigation.NavigateTo("/admin/grocery-items");
  }

  public class GroceryItemInput
  {
    [Required(ErrorMessage = "Name is required")]
    [StringLength(200, ErrorMessage = "Name cannot exceed 200 characters")]
    public string Name { get; set; } = "";

    [Required(ErrorMessage = "Price is required")]
    [Range(0.01, 999999.99, ErrorMessage = "Price must be between $0.01 and $999,999.99")]
    public decimal Price { get; set; }

    [StringLength(1000, ErrorMessage = "Description cannot exceed 1000 characters")]
    public string? Description { get; set; }

    [Required(ErrorMessage = "Category is required")]
    [StringLength(100)]
    public string? Category { get; set; }

    [Url(ErrorMessage = "Please enter a valid URL")]
    [StringLength(500)]
    public string? ImageUrl { get; set; }

    [Required(ErrorMessage = "Stock is required")]
    [Range(0, 999999, ErrorMessage = "Stock must be between 0 and 999,999")]
    public int Stock { get; set; }

    public bool IsAvailable { get; set; }
  }
}